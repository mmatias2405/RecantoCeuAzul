<!doctype html>
<html lang="pt-br">
<head>
    <link href="customStyles.css" rel="stylesheet">
    <title>Recanto do Céu Azul</title>
    <link rel="icon" type="image/png" href="/images/rcu_logo.png">
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    
    <!-- Bootstrap CSS v5.2.1 -->
    <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
    crossorigin="anonymous"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
</head>

<body>
    <header>
        <nav class="navbar navbar-expand-md navbar-dark bg-body-tertiary gradient-custom">
            <div class="container-fluid">
                <a class="navbar-brand" href="/morador?residencia=0">Residencial Recanto do Céu Azul</a>
                <div class="d-flex">
                    <ul class="navbar-nav">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle text-white" href="#" id="navbarDarkDropdownMenuLink" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            Bem Vindo(a)!&nbsp;<span th:text=" ${nomeUsuario}"> </span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-md-end"
                        aria-labelledby="navbarDarkDropdownMenuLink">
                        <li><a class="dropdown-item" href="/consumo">Registro de Consumo</a></li>
                        <li><a class="dropdown-item" href="/usuario">Registro de Usuário</a></li>
                        <li><a class="dropdown-item" href="/residencia">Registro de Residência</a></li>
                        <li><a class="dropdown-item" href="/logout">Logout</a></li>
                    </ul>
                </li>
            </ul>
        </div>
        
    </nav>
</header>
    <div class="container-fluid">
        <h1 class="h3 mt-3 font-weight-normal">Dashboard</h1>
        <div class="row justify-content-center g-2 mt-3">
            <div th:if="${mensagemSucesso}" th:text="${mensagemSucesso}" class="alert alert-success" role="alert"></div>
            <div th:if="${mensagem}" th:text="${mensagem}" class="alert alert-danger" role="alert"></div>
            <div class="col-lg-6 col-md-12 col-sm-12 p-2">
                
                <h5 class="my-3"><span id="qtdResidenciasSemMedicao"></span>&nbsp;Residências sem registro de consumo desse mês</h5>
                <table class="table table-bordered align-middle">
                    <thead>
                        <tr>
                            <th class="text-center">Número da Residência</th>
                            <th class="text-center">Ação</th>
                        </tr>
                    </thead>
                    <tbody id="corpoTabelaResidencia">
                    </tbody>
                    <caption class="text-center">
                        <a href="/consumo">Ver mais...</a>
                    </caption>
                </table>
            </div>
            <div class="col-lg-6 col-md-1 col-sm-1 p-3">
                <h5 class="my-3"><span id="qtdAtorSemPapel"></span>&nbsp;Usuários aguardando aprovação</h5>
                <table class="table table-bordered align-middle">
                    <tbody id="corpoTabelaAtor">
                    </tbody>
                    <caption class="text-center">
                        <a href="/usuario">Ver mais ...</a>
                    </caption>
                </table>
            </div>
        </div>
        <hr>
        <h5 class="my-3">Dados gerais do condominio</h5>
        <div id="cards-container" class="d-flex my-2 overflow-x-auto gap-2">
        </div>
        <hr>
        
    </div> 
    <div
    class="modal fade"
    id="approvalModal"
    tabindex="-1"
    aria-labelledby="approvalModalLabel"
    aria-hidden="true"
    >
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="approvalModalLabel">Aprovar Usuário</h5>
                <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
                ></button>
            </div>
            <div class="modal-body">
                <p>
                    <strong>Nome:</strong>
                    <span id="modalUserName"></span>
                </p>
                <p>
                    <strong>Email:</strong>
                    <span id="modalUserEmail"></span>
                </p>
                <p>
                    <strong>Telefone:</strong>
                    <span id="modalUserPhone"></span>
                </p>
                
                <hr />
                
                <form id="approvalForm" action="/aprovarAtor" method="post">
                    <div class="mb-3">
                        <label for="roleSelect" class="form-label">Definir Papel:</label>
                        <select required class="form-select" id="roleSelect" name="papel">
                            <option selected disabled value="">Selecione um papel...</option>
                            <option value="MORAR">Morador</option>
                            <option value="ADMIN">Administrador</option>
                            <option value="FISCA">Fiscal</option>
                        </select>
                    </div>
                    
                    <div id="residenceContainer" class="mt-3" style="display: none">
                        <label class="form-label">Vincular Residências:</label>
                        <div class="row g-2">
                            <div class="col-5">
                                <label for="availableResidences" class="form-label small">Disponíveis</label>
                                <select multiple class="form-select" id="availableResidences" size="8"></select>
                            </div>
                            
                            <div class="col-2 d-flex flex-column justify-content-center align-items-center">
                                <button type="button" class="btn btn-secondary btn-sm mb-2" id="addResidenceBtn" title="Adicionar">
                                    &gt;
                                </button>
                                <button type="button" class="btn btn-secondary btn-sm" id="removeResidenceBtn" title="Remover">
                                    &lt;
                                </button>
                            </div>
                            
                            <div class="col-5">
                                <label for="selectedResidences" class="form-label small">Selecionadas</label>
                                <select multiple name="residencias" class="form-select" id="selectedResidences" size="8"></select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                        >
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary" id="saveApprovalBtn">
                        Salvar e Aprovar
                    </button>
                </div>
            </form>
        </div>
        
    </div>
</div>
</div>
<!-- MODAL CONSUMO -->
<div
class="modal fade"
id="consumoModal"
tabindex="-1"
aria-labelledby="consumoModalLabel"
aria-hidden="true"
>
<div class="modal-dialog">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="consumoModalLabel">Registrar Consumo</h5>
            <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
            ></button>
        </div>
        <div class="modal-body">
            <form id="consumoForm" method="post" action="/registrarConsumo">
                <div class="mb-3">
                    <p>
                        <strong>Residência Selecionada:</strong>
                        <span id="modalResidencia"></span>
                    </p>
                </div>
                <div class="mb-3">
                    <label for="volume" class="sr-only">Insira o leitura do Hidrômetro(m³)</label>
                    <input type="number" name="volumeAgua"step="0.1" id="volume" class="form-control" placeholder="Volume"  required>
                    <input type="hidden" name="residenciaId" id="resIdForPost">
                    <input type="hidden" name="atorId" value="0">
                </div>
                <div class="modal-footer">
                    <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                    >
                    Cancelar
                </button>
                <button type="submit" class="btn btn-primary" id="saveConsumolBtn">
                    Registrar
                </button>
            </div>
            
        </form>
    </div>
    
</div>
</div>
</div>
<!-- Bootstrap JavaScript Libraries -->
<script
src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
crossorigin="anonymous"
></script>

<script
src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
crossorigin="anonymous"
></script>
<script th:inline="javascript">
    var dadosGerais = /*[[${dadosGerais}]]*/ [];
    var atoresSemPapel = /*[[${atoresSemPapel}]]*/ [];
    var residenciasSemMedicao = /*[[${residenciasSemMedicao}]]*/ [];
    var allResidencias = /*[[${allResidencias}]]*/ [];
    var atorId = 0;
    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("qtdResidenciasSemMedicao").textContent = residenciasSemMedicao.length;
        document.getElementById("qtdAtorSemPapel").textContent = atoresSemPapel.length;
        
        const container = document.getElementById('cards-container')
        container.innerHTML = '';
        
        dadosGerais.forEach(dadoGeral => {
            const cardHTML = `
                <div style="min-width: 180px;"><div class="card text-center">
                        <div class="card-header gradient-card">
                            <strong class="text-white">${dadoGeral.mesAno}</strong>
                        </div>
                        <div class="card-body">
                            <p class="card-text">Consumo Total: ${dadoGeral.consumoTotal} m<sup>3</sup></p>
                            <p class="card-text">Medições realizadas: ${dadoGeral.medicoesRealizadas}</p>
                            <p class="card-text">Média de Consumo: ${dadoGeral.mediaConsumo} m<sup>3</sup></p>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += cardHTML;
        });
        
        const corpoTabelaAtor = document.getElementById('corpoTabelaAtor')
        corpoTabelaAtor.innerHTML = '';
        atoresSemPapel.forEach(ator => {
            const trHTML = `
                <tr>
                    <td class="text-center">${ator.nome}</td>
                    <td class="text-center">
                        <button type="button" class="btn btn-primary" 
                        data-bs-toggle="modal"
                        data-bs-target="#approvalModal"
                        data-user-id="${ator.id}"
                        data-user-name="${ator.nome}"
                        data-user-email="${ator.email}"
                        data-user-phone="${ator.telefone}">
                        Aprovar
                    </button>
                    </td>
                </tr>
            `;
            corpoTabelaAtor.innerHTML += trHTML;
        });
        
        const corpoTabelaResidencia = document.getElementById('corpoTabelaResidencia')
        corpoTabelaResidencia.innerHTML = '';
        residenciasSemMedicao.forEach(residencia => {
            const trHTML = `
                <tr>
                    <td class="text-center">${residencia.numero}</td>
                    <td class="text-center">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#consumoModal" data-res-num="${residencia.numero}"" data-res-id="${residencia.id}">
                            Registrar Consumo
                        </button>
                    </td>
                </tr>
            `;
            corpoTabelaResidencia.innerHTML += trHTML;
        });
        
        const consumoModal = document.getElementById("consumoModal");
        consumoModal.addEventListener("show.bs.modal", function (event) {
            const button = event.relatedTarget;
            const residenciaId = button.getAttribute("data-res-id");
            const residenciaNumero = button.getAttribute("data-res-num");
            
            consumoModal.querySelector("#modalResidencia").textContent = residenciaNumero;
            document.getElementById("resIdForPost").value = residenciaId;
            
        });
        
        consumoModal.addEventListener("hidden.bs.modal", function (event) {
            document.getElementById("consumoForm").reset();
        });
        
        const approvalModal = document.getElementById("approvalModal");
        approvalModal.addEventListener("show.bs.modal", function (event) {
            const button = event.relatedTarget;
            const userName = button.getAttribute("data-user-name");
            const userId = button.getAttribute("data-user-id");
            const userEmail = button.getAttribute("data-user-email");
            const userPhone = button.getAttribute("data-user-phone");
            atorId = button.getAttribute("data-user-id");
            
            approvalModal.querySelector("#modalUserName").textContent = userName;
            approvalModal.querySelector("#modalUserEmail").textContent = userEmail;
            approvalModal.querySelector("#modalUserPhone").textContent = userPhone;
            
            populateAvailableResidences(); 
            residenceContainer.style.display = "none";
            roleSelect.value = "";
            
        });
        
        const roleSelect = document.getElementById("roleSelect");
        const residenceContainer = document.getElementById("residenceContainer");
        const availableResidences = document.getElementById("availableResidences");
        const selectedResidences = document.getElementById("selectedResidences");
        const addResidenceBtn = document.getElementById("addResidenceBtn");
        const removeResidenceBtn = document.getElementById("removeResidenceBtn");
        
        /**
        * Função para popular a lista de residências disponíveis
        * e limpar a lista de selecionadas.
        */
        function populateAvailableResidences() {
            availableResidences.innerHTML = ''; // Limpa lista
            selectedResidences.innerHTML = ''; // Limpa lista
            
            // Pega a variável global 'allResidencias' que você já tem
            allResidencias.forEach(res => {
                // Cria um <option>
                    const option = new Option(`Residência ${res.numero}`, res.id);
                    availableResidences.add(option);
                });
            }
            
            /**
            * Função genérica para mover <option> selecionados
                * de uma lista (source) para outra (destination).
                */
                function moveOptions(sourceList, destList) {
                    // Pega todos os <option> que estão selecionados
                        const selectedOptions = Array.from(sourceList.selectedOptions);
                        
                        selectedOptions.forEach(option => {
                            // Remove da lista de origem
                            sourceList.remove(option.index);
                            // Adiciona na lista de destino
                            destList.add(option);
                        });
                    }
                    
                    // 1. Ouvinte para MOVER de Disponível -> Selecionada
                    addResidenceBtn.addEventListener("click", function() {
                        moveOptions(availableResidences, selectedResidences);
                    });
                    
                    // 2. Ouvinte para MOVER de Selecionada -> Disponível
                    removeResidenceBtn.addEventListener("click", function() {
                        moveOptions(selectedResidences, availableResidences);
                    });
                    
                    // 3. Ouvinte para mostrar/esconder o container
                    roleSelect.addEventListener("change", function() {
                        if (this.value === "MORAR") {
                            residenceContainer.style.display = "block";
                        } else {
                            residenceContainer.style.display = "none"; // Esconde
                        }
                    });
                    
                    
                    document.getElementById("saveApprovalBtn").addEventListener("click", function() {
                        const role = roleSelect.value;
                        
                        console.log("Papel Selecionado:", role);
                        console.log("Residências Selecionadas:", selectedResidences);
                    });
                });
                // Ache o formulário
                const approvalForm = document.getElementById("approvalForm");
                
                // Adicione um "ouvinte" para o evento SUBMIT
                approvalForm.addEventListener("submit", function(event) {
                    
                    // 1. PARE O ENVIO PADRÃO OBRIGATORIAMENTE!
                    // Isso impede que a página recarregue e nos dá tempo de validar.
                    event.preventDefault(); 
                    
                    // 2. Pegue os valores (exatamente como antes)
                    const role = roleSelect.value;
                    const selectedOptions = Array.from(selectedResidences.options);
                    const selectedResidenceIDs = selectedOptions.map(option => option.value);
                    
                    // 3. Faça a validação (exatamente como antes)
                    if (role === "MORAR" && selectedResidenceIDs.length === 0) {
                        alert("Para o papel 'Morador', você deve selecionar pelo menos uma residência.");
                        return; // Para a função aqui
                    }
                    
                    
                    const dataToSend = {
                        papel: role,
                        residencias: selectedResidenceIDs,
                        atorId: atorId
                    };
                    fetch('/aprovarAtor', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json' 
                        },
                        body: JSON.stringify(dataToSend) 
                    }).then(response => {
                        if (!response.ok) {
                            alert('Ocorreu um erro ao salvar os dados.');
                        } else {
                            // Se deu certo (response.ok), NÓS mandamos navegar
                            location.reload(); // Recarrega a página atual
                            // ou
                            // window.location.href = "/"; // Vai para a página inicial
                        }
                    })
                    .catch(error => {
                        console.error('Erro de rede:', error);
                        alert('Falha de conexão. Tente novamente.');
                    });
                    
                });
            </script>
        </body>
        </html>