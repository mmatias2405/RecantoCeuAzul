<!doctype html>
<html lang="pt-br">
<head>
    <link href="customStyles.css" rel="stylesheet">
    <title>Recanto do Céu Azul</title>
    <link rel="icon" type="image/png" href="/images/rcu_logo.png">
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    
    <!-- Bootstrap CSS v5.2.1 -->
    <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
    crossorigin="anonymous"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <header>
        <nav class="navbar navbar-expand-md navbar-dark bg-body-tertiary gradient-custom">
            <div class="container-fluid">
                                <a class="navbar-brand" href="/morador?residencia=0">Residencial Recanto do Céu Azul</a>
                <div class="d-flex">
                    <ul class="navbar-nav">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle text-white" href="#" id="navbarDarkDropdownMenuLink" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            Bem Vindo(a)!&nbsp;<span th:text=" ${nomeUsuario}"> </span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-md-end"
                        aria-labelledby="navbarDarkDropdownMenuLink">
                        <li><a class="dropdown-item" href="/logout">Logout</a></li>
                    </ul>
                </li>
            </ul>
        </div>

        </nav>
    </header>
    <div class="container-fluid">
        
        <div class="row my-4 align-items-center">
            <div class="col col-md-auto"> 
                <h5 class="mb-0">Selecione a residência que deseja visualizar</h5>
            </div>
            <div class="col-auto">
                <form action="/morador" method="get">
                    <select class="form-select" aria-label="Default select example" name="residencia" id="residencia">
                        <option th:each="s : ${residencias}" 
                        th:value="${s.id}" 
                        th:text="${s.numero}">
                    </option>
                </select>
                <button type="submit" class="btn btn-primary mt-1">Pesquisar</button>
            </form>
        </div>
    </div>
    <hr>
    <h5 class="mb-0">Visualizando dados da residência número&nbsp;<span th:text="${residenciaNumero}"></span></h5>
    <div id="cards-container" class="d-flex my-2 overflow-x-auto gap-2">
    </div> 
    
</div> 
<hr>
<div class="mt-2" style="width: 100%; max-width: 900px; margin: 40px auto 0;">
    <h5 class="mb-2">Histórico de consumo:</h5>
    <canvas id="meuGrafico"></canvas>
</div>
<!-- Modal -->
<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staticBackdropLabel">Detalhes da Medição</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <strong>Marcação no Hidrômetro:</strong>
                        <span id="modal-volume"></span>
                    </li>
                    <li class="list-group-item">
                        <strong>Consumo (Delta):</strong>
                        <span id="modal-consumo"></span>
                    </li>
                    <li class="list-group-item">
                        <strong>Data da Leitura:</strong>
                        <span id="modal-data"></span>
                    </li>
                    <li class="list-group-item">
                        <strong>Responsável pela Leitura:</strong>
                        <span id="modal-ator"></span>
                    </li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
<script th:inline="javascript">
    var medicoes = /*[[${medicoes}]]*/ [];
    var medias = /*[[${medias}]]*/ [];
    // ----- INÍCIO DO SCRIPT -----
    
    // Espera o DOM estar pronto para executar o script
    document.addEventListener("DOMContentLoaded", function() {
        
        // +++ 1. Criar um "mapa de lookup" para as médias +++
        //    Isso transforma o array 'medias' em um objeto para consulta rápida.
        //    Ex: { "05/2025": 12.39, "06/2025": 13.01, ... }
        const mediaLookup = medias.reduce((acc, media) => {
            acc[media.mesAno] = media.mediaConsumo;
            return acc;
        }, {});
        
        // 2. Seleciona o container onde os cards serão inseridos
        const container = document.getElementById('cards-container');
        
        // 3. Limpa o container caso já tenha algo (boa prática)
        container.innerHTML = '';
        
        // 4. Itera sobre cada 'medicao' no seu array
        medicoes.forEach(medicao => {
            
            // 5. Lógica para formatar a data (MM/YYYY)
            const data = new Date(medicao.dataMedicao);
            const mes = String(data.getMonth() + 1).padStart(2, '0'); // getMonth() é 0-11, por isso +1
            const ano = data.getFullYear();
            const dataHeader = `${mes}/${ano}`; // Este é o formato "MM/YYYY"
            
            // +++ 6. Buscar a média específica para este mês usando o 'mediaLookup' +++
            //    Se não encontrar (||), usamos 0 como padrão.
            const mediaDoMes = mediaLookup[dataHeader] || 0;
            
            // +++ 7. Lógica para a classe do consumo (verde ou vermelho) usando a mediaDoMes +++
            const classeConsumo = medicao.delta > mediaDoMes ? 'text-danger' : 'text-success';
            
            // 8. Cria o HTML do card usando Template Literals (crases ``)
            //    Adicionamos 'data-id' ao botão para saber qual medição buscar depois
            const cardHTML = `
        <div style="min-width: 180px;" class="m-2"> <div class="card text-center">
                <div class="card-header gradient-card">
                    <strong class="text-white">${dataHeader}</strong>
                </div>
                <div class="card-body">
                    <p class="card-text">Consumo: <span class="${classeConsumo}">${medicao.delta.toFixed(1)} m<sup>3</sup></span></p>

                    <p class="card-text">Média: ${mediaDoMes.toFixed(1)} m<sup>3</sup></p>

                    <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#staticBackdrop" data-id="${medicao.id}">
                        Ver Detalhe
                    </a>
                </div>
            </div>
        </div>
        `;
            
            // 10. Insere o card gerado dentro do container
            container.innerHTML += cardHTML;
        });
        
        // ----- LÓGICA DO MODAL -----
        // (Nenhuma alteração necessária no modal, pois ele só mostra os dados da 'medicao')
        
        // 9. Seleciona o próprio modal
        const modalElement = document.getElementById('staticBackdrop');
        
        // 10. Seleciona os campos de texto dentro do modal
        const modalVolume = document.getElementById('modal-volume');
        const modalConsumo = document.getElementById('modal-consumo');
        const modalData = document.getElementById('modal-data');
        const modalAtor = document.getElementById('modal-ator');
        const modalTitulo = document.getElementById('staticBackdropLabel');
        
        // 11. Adiciona um "escutador" de evento ao modal.
        //     Isso é disparado TODA VEZ que o modal está prestes a ser aberto.
        modalElement.addEventListener('show.bs.modal', function (event) {
            
            // 12. Pega o botão que acionou o modal (o 'Ver Detalhe' que foi clicado)
            const button = event.relatedTarget;
            
            // 13. Pega o 'data-id' que armazenamos no botão
            const medicaoId = parseInt(button.getAttribute('data-id'), 10);
            
            // 14. Encontra o objeto 'medicao' correspondente no array original
            const medicao = medicoes.find(m => m.id === medicaoId);
            
            // 15. Formata a data e hora para exibição no modal
            const dataLeitura = new Date(medicao.dataMedicao).toLocaleString('pt-BR', {
                dateStyle: 'short',
                timeStyle: 'short'
            });
            
            // 16. Formata o título do modal
            const data = new Date(medicao.dataMedicao);
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear();
            
            // 17. Preenche o HTML do modal com os dados encontrados
            modalTitulo.textContent = `Detalhes da Medição (${mes}/${ano})`;
            modalVolume.textContent = `${medicao.volumeAgua.toFixed(1)} m³`;
            modalConsumo.textContent = `${medicao.delta.toFixed(1)} m³`;
            modalData.textContent = dataLeitura;
            modalAtor.textContent = medicao.ator.nome;
        });
        
        
        // ----- LÓGICA DO GRÁFICO -----
        
        // 1. Preparar os dados para o gráfico
        //    Gráficos ficam melhores em ordem cronológica (do mais antigo para o mais novo)
        //    Usamos [...medicoes] para criar uma CÓPIA antes de inverter, para não afetar os cards.
        const medicoesInvertidas = [...medicoes].reverse();
        
        // 2. Criar os arrays de 'labels' (eixo X) e 'data' (eixo Y)
        const labelsGrafico = medicoesInvertidas.map(m => {
            const data = new Date(m.dataMedicao);
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear();
            return `${mes}/${ano}`; // Ex: "05/2025"
        });
        
        const consumoDataGrafico = medicoesInvertidas.map(m => m.delta); // Ex: [12.45, 8.79, ...]
        
        // +++ 3. Criar o array de dados da "Média" (agora variável) +++
        //    Mapeamos os 'labels' do gráfico e usamos o 'mediaLookup'
        //    para encontrar a média de CADA mês correspondente.
        const mediaDataGrafico = labelsGrafico.map(label => mediaLookup[label] || 0);
        // Ex: [12.39, 13.01, 11.87, ...] (em vez de [50, 50, 50, ...])
        
        
        // 4. Pegar o 'contexto' 2D do nosso canvas
        const ctx = document.getElementById('meuGrafico').getContext('2d');
        
        // 5. Criar o gráfico!
        const meuGrafico = new Chart(ctx, {
            type: 'line', // Tipo do gráfico
            data: {
                labels: labelsGrafico, // Nossos labels do eixo X
                datasets: [
                {
                    // Linha de Consumo
                    label: 'Consumo (m³)',
                    data: consumoDataGrafico, // Nossos dados do eixo Y
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    fill: true,
                    tension: 0.1 // Deixa a linha levemente curvada
                },
                {
                    // Linha da Média (agora variável)
                    label: 'Média (m³)',
                    data: mediaDataGrafico, // Nossos dados da média (agora dinâmicos)
                    borderColor: 'rgb(255, 99, 132)', // Cor vermelha
                    borderDash: [5, 5], // Faz a linha ser pontilhada
                    fill: false,
                    pointRadius: 0 // Não mostra pontos na linha da média
                }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Consumo (m³)'
                        }
                    }
                }
            }
        });
    });
</script>
<!-- Bootstrap JavaScript Libraries -->
<script
src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
crossorigin="anonymous"
></script>

<script
src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
crossorigin="anonymous"
></script>
</body>
</html>
